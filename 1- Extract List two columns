from docx.shared import Inches, Pt
from math import ceil

def insert_technologies_table(doc, tech_data):
    # Localiza o parágrafo com a tag
    placeholder_paragraph = None
    for p in doc.paragraphs:
        if "{table_technologies}" in p.text:
            placeholder_paragraph = p
            break

    if not placeholder_paragraph:
        raise ValueError("Marcador {table_technologies} não encontrado.")

    # Monta linhas com categorias e tecnologias
    rows = []
    for bloc in tech_data:
        rows.append({"is_category": True, "categorie": bloc.categorie})
        for info in bloc.infos:
            rows.append({"is_category": False, "nom": info.nom, "mois": info.mois})

    mid = ceil(len(rows) / 2)
    left_rows = rows[:mid]
    right_rows = rows[mid:]

    # Cria a tabela antes do marcador
    table = placeholder_paragraph.insert_paragraph_before().insert_table(rows=0, cols=4)
    table.autofit = False
    widths = [Inches(2), Inches(0.7), Inches(2), Inches(0.7)]

    # Cabeçalho
    hdr_cells = table.add_row().cells
    headers = ['Technologie', 'Mois', 'Technologie', 'Mois']
    for i, cell in enumerate(hdr_cells):
        cell.text = headers[i]
        run = cell.paragraphs[0].runs[0]
        run.font.bold = True
        run.font.size = Pt(10)
        cell.width = widths[i]

    def set_cell_style(cell, bold=False):
        for paragraph in cell.paragraphs:
            for run in paragraph.runs:
                run.font.size = Pt(10)
                run.font.bold = bold

    for i in range(max(len(left_rows), len(right_rows))):
        row_cells = table.add_row().cells

        # Lado esquerdo
        if i < len(left_rows):
            item = left_rows[i]
            if item["is_category"]:
                row_cells[0].text = item["categorie"]
                row_cells[1].text = ""
                set_cell_style(row_cells[0], bold=True)
            else:
                row_cells[0].text = item["nom"]
                row_cells[1].text = str(item["mois"])
                set_cell_style(row_cells[0])
                set_cell_style(row_cells[1])
        else:
            row_cells[0].text = ""
            row_cells[1].text = ""

        # Lado direito
        if i < len(right_rows):
            item = right_rows[i]
            if item["is_category"]:
                row_cells[2].text = item["categorie"]
                row_cells[3].text = ""
                set_cell_style(row_cells[2], bold=True)
            else:
                row_cells[2].text = item["nom"]
                row_cells[3].text = str(item["mois"])
                set_cell_style(row_cells[2])
                set_cell_style(row_cells[3])
        else:
            row_cells[2].text = ""
            row_cells[3].text = ""

        for j in range(4):
            row_cells[j].width = widths[j]

    placeholder_paragraph.clear()
